---
title:  'Computational Musicology'
author: 'Max Koste'
date:   'February--March 2020'
output: 
    flexdashboard::flex_dashboard:
        storyboard: true
        theme: journal
---

```{r setup}
library(tidyverse)
library(knitr)
library(plotly)
library(spotifyr)
library(compmus)
library(shiny)
library(shinydashboard)
library(ggjoy)
source('spotify.R')

stones_old <- get_playlist_audio_features('spotify', '4M2hsYvNxtTQYYdJXM7nZf')
stones_new <- get_playlist_audio_features('spotify', '5O8ZKa73hlfLYXnRLbU1xk')

stones <- stones_old %>% mutate(playlist = "stones_old") %>%
  bind_rows(stones_new %>% mutate(playlist = "stones_new"))

theme_max <- function() {
  theme_minimal() +
    theme(
      text = element_text(color = "gray25"),
      plot.subtitle = element_text(size = 12),
      plot.caption = element_text(color = "gray30"),
      plot.background = element_rect(fill = "gray95"),
      plot.margin = unit(c(5, 10, 5, 10), units = "mm")
      
    )
}

```

### Mean Mr Mustard Keyprofile
```{r}
circshift <- function(v, n) {if (n == 0) v else c(tail(v, n), head(v, -n))}
                                    
    # C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B 
major_chord <- 
    c(1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
minor_chord <- 
    c(1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
seventh_chord <- 
    c(1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)

major_key <- 
    c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
    c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)

chord_templates <-
    tribble(
        ~name  , ~template,
        'Gb:7'  , circshift(seventh_chord,  6),
        'Gb:maj', circshift(major_chord,    6),
        'Bb:min', circshift(minor_chord,   10),
        'Db:maj', circshift(major_chord,    1),
        'F:min' , circshift(minor_chord,    5),
        'Ab:7'  , circshift(seventh_chord,  8),
        'Ab:maj', circshift(major_chord,    8),
        'C:min' , circshift(minor_chord,    0),
        'Eb:7'  , circshift(seventh_chord,  3),
        'Eb:maj', circshift(major_chord,    3),
        'G:min' , circshift(minor_chord,    7),
        'Bb:7'  , circshift(seventh_chord, 10),
        'Bb:maj', circshift(major_chord,   10),
        'D:min' , circshift(minor_chord,    2),
        'F:7'   , circshift(seventh_chord,  5),
        'F:maj' , circshift(major_chord,    5),
        'A:min' , circshift(minor_chord,    9),
        'C:7'   , circshift(seventh_chord,  0),
        'C:maj' , circshift(major_chord,    0),
        'E:min' , circshift(minor_chord,    4),
        'G:7'   , circshift(seventh_chord,  7),
        'G:maj' , circshift(major_chord,    7),
        'B:min' , circshift(minor_chord,   11),
        'D:7'   , circshift(seventh_chord,  2),
        'D:maj' , circshift(major_chord,    2),
        'F#:min', circshift(minor_chord,    6),
        'A:7'   , circshift(seventh_chord,  9),
        'A:maj' , circshift(major_chord,    9),
        'C#:min', circshift(minor_chord,    1),
        'E:7'   , circshift(seventh_chord,  4),
        'E:maj' , circshift(major_chord,    4),
        'G#:min', circshift(minor_chord,    8),
        'B:7'   , circshift(seventh_chord, 11),
        'B:maj' , circshift(major_chord,   11),
        'D#:min', circshift(minor_chord,    3))

key_templates <-
    tribble(
        ~name    , ~template,
        'Gb:maj', circshift(major_key,  6),
        'Bb:min', circshift(minor_key, 10),
        'Db:maj', circshift(major_key,  1),
        'F:min' , circshift(minor_key,  5),
        'Ab:maj', circshift(major_key,  8),
        'C:min' , circshift(minor_key,  0),
        'Eb:maj', circshift(major_key,  3),
        'G:min' , circshift(minor_key,  7),
        'Bb:maj', circshift(major_key, 10),
        'D:min' , circshift(minor_key,  2),
        'F:maj' , circshift(major_key,  5),
        'A:min' , circshift(minor_key,  9),
        'C:maj' , circshift(major_key,  0),
        'E:min' , circshift(minor_key,  4),
        'G:maj' , circshift(major_key,  7),
        'B:min' , circshift(minor_key, 11),
        'D:maj' , circshift(major_key,  2),
        'F#:min', circshift(minor_key,  6),
        'A:maj' , circshift(major_key,  9),
        'C#:min', circshift(minor_key,  1),
        'E:maj' , circshift(major_key,  4),
        'G#:min', circshift(minor_key,  8),
        'B:maj' , circshift(major_key, 11),
        'D#:min', circshift(minor_key,  3))
```

```{r}
mr_mustard <- 
    get_tidy_audio_analysis('4JOyMhad5dD81uGYLGgKrS') %>% 
    compmus_align(sections, segments) %>% 
    select(sections) %>% unnest(sections) %>% 
    mutate(
        pitches = 
            map(segments, 
                compmus_summarise, pitches, 
                method = 'mean', norm = 'manhattan'))
    
```

```{r}
mr_mustard %>% 
    compmus_match_pitch_template(key_templates, 'euclidean', 'manhattan') %>% 
    ggplot(
        aes(x = start + duration / 2, width = duration, y = name, fill = d)) +
    geom_tile() +
    scale_fill_viridis_c(option = 'E', guide = 'none') +
    theme_max() +
    labs(x = 'Time (s)', y = '')
```

*** 
Mean Mr Mustard is the song with the highest valence in our corpus so lets look at its key structure.
```{r}

stones%>%
  arrange(-valence)%>%
  select(track.name, valence)%>%
  head(5)%>%
  kable()


```

As we can see it is giving use some strange readings since we have both G#m and G in the same section which is very strange. 

### What is the SD and Mean Bpm between our old and modern hits?
```{r}
stones_old_analysis <-
    get_playlist_audio_features(
        'rollingstones_old', 
        '4M2hsYvNxtTQYYdJXM7nZf') %>% 
    slice(1:30) %>% 
    add_audio_analysis()
stones_new_analysis <-
    get_playlist_audio_features(
        'rollingstones_new', 
        '5O8ZKa73hlfLYXnRLbU1xk') %>% 
    slice(1:30) %>% 
    add_audio_analysis()
pop_music <-
    stones_old_analysis %>% mutate(genre = "60s/70s") %>%
    bind_rows(stones_new_analysis %>% mutate(genre = "Modern"))
```

```{r}
pop_music %>% 
    mutate(
        sections = 
            map(
                sections, 
                summarise_at, 
                vars(tempo, loudness, duration), 
                list(section_mean = mean, section_sd = sd))) %>% 
    unnest(sections) %>%
    ggplot(
        aes(
            x = tempo, 
            y = tempo_section_sd, 
            colour = genre, 
            alpha = loudness)) +
    geom_point(aes(size = duration / 60)) + 
    geom_rug() + 
    theme_max() +
    ylim(0, 5) + 
    labs(
        x = 'Mean Tempo (bpm)', 
        y = 'SD Tempo', 
        colour = 'Genre', 
        size = 'Duration (min)', 
        alpha = 'Volume (dBFS)')
```

### Timbre Coefficent 
```{r}
pop_music %>% 
    mutate(
        timbre =
            map(
                segments,
                compmus_summarise,
                timbre,
                method = 'mean')) %>%
    select(genre, timbre) %>% 
    compmus_gather_timbre %>% 
    ggplot(aes(x = basis, y = value, fill = genre)) +
    geom_violin() +
    theme_max ()+
    scale_fill_viridis_d() +
    labs(x = 'Spotify Timbre Coefficients', y = '', fill = 'Genre')
```


### Otis reading rock me baby

```{r}
bzt <- 
    get_tidy_audio_analysis('0OY4ztej0wqS7AF2pHHtCu') %>% 
    compmus_align(bars, segments) %>% 
    select(bars) %>% unnest(bars) %>% 
    mutate(
        pitches = 
            map(segments, 
                compmus_summarise, pitches, 
                method = 'rms', norm = 'euclidean')) %>% 
    mutate(
        timbre = 
            map(segments, 
                compmus_summarise, timbre, 
                method = 'mean'))


```

```{r}
bzt %>% 
    compmus_gather_timbre %>% 
    ggplot(
        aes(
            x = start + duration / 2, 
            width = duration, 
            y = basis, 
            fill = value)) + 
    geom_tile() +
    labs(x = 'Time (s)', y = NULL, fill = 'Magnitude') +
    scale_fill_viridis_c(option = 'E') +
    theme_classic()
```


```{r}
bzt %>% 
    compmus_self_similarity(timbre, 'cosine') %>% 
    ggplot(
        aes(
            x = xstart + xduration / 2, 
            width = xduration,
            y = ystart + yduration / 2,
            height = yduration,
            fill = d)) + 
    geom_tile() +
    coord_fixed() +
    scale_fill_viridis_c(option = 'E', guide = 'none') +
    theme_classic() +
    labs(x = '', y = '')
```

***

Here we can see when the horns take up more space in the mix which is indicated by a the same change in the overal timbre of the song by the yellow area between 100-150s. Otherwise the song is very similiar throughout the piece without much difference between the choruses and the verses. 

### The division of valence between the old albums

```{r}



stones <- stones_old %>% mutate(playlist = "stones_old") %>%
  bind_rows(stones_new %>% mutate(playlist = "stones_new"))

ggplot(stones_old, aes(x = valence, y = track.album.name)) + 
  geom_joy() + 
  theme_joy() +
  ggtitle("The division of valence")+
  theme_max()+
  theme(plot.margin = margin(1 ,1 , 1, 1, "cm"), axis.text = element_text(size = 5))+
  labs(y = "Album Names", x = "Valence")
  

```

***
the division of valence is quite varied amongst the albums and only dark side of the moon seems to be extreme in being concentrated towards the lower end of the spectrum. Hotel california is also interseting since its valence is divided on each end of the spectrum without any concentration in the middle. Here is also the mean valence of the 5 albums with the highest mean. 

```{r}
stones_old%>%
  arrange(-valence)%>%
  select(track.album.name, valence)%>%
  head(5)%>%
  kable()
```

### The division of valence between the newer albums

```{r}
ggplot(stones_new, aes(x = valence, y = track.album.name)) + 
  geom_joy() + 
  theme_joy() +
  ggtitle("The division of valence")+
  theme_max()+
  theme(plot.margin = margin(1 ,1 , 1, 1, "cm"), axis.text = element_text(size = 10))+
  labs(y = "Album Names", x = "Valence")
  

```

***

Where the older albums were varied the newer albums are more predictable since they are more or less centered towards the middle of the scale with variying degrees of concentration. The albums are either in the middle or towards the lower end of the spectrum. maybe indicating a shift in trends towards more gloomy music. Here we can also see values for the 5 albums with the highest mean valence.

```{r}
stones_new%>%
  arrange(-valence)%>%
  select(track.album.name, valence)%>%
  head(5)%>%
  kable()

```

### Introduction

What makes a succesfull album. I will look at some of the most iconic and top rated albums pulling data from the rolling stones magazine top 500 list of albums and then comparing their characteristics to a similair list by the rolling stones magazine from the 2000s. 

We will check for features and similarities between succesfull albums that can be observed. This will be done by gathering data from Spotify from a selection of succesfull albums from the 70s and 60s. This will then be compared to the top albums of the 2000s also from the rolling stones. 

```{r}
stones_old <- get_playlist_audio_features('spotify', '4M2hsYvNxtTQYYdJXM7nZf')
stones_new <- get_playlist_audio_features('spotify', '5O8ZKa73hlfLYXnRLbU1xk')


stones <- stones_old %>% mutate(playlist = "stones_old") %>%
  bind_rows(stones_new %>% mutate(playlist = "stones_new"))
```


### The newer tracks are louder but not that much more danceable


```{r}


Rock <-
stones %>%
  ggplot(aes(x = danceability, y = loudness, col = playlist, label = track.name, size = (valence/energy))) + 
  geom_point(alpha = 0.6, position = "jitter") + 
  geom_rug(size = 0.1)+
  facet_wrap('playlist')+
  theme_max()


ggplotly(Rock)
```

***

In this graph we see that the loudest songs in our data set comes from the new playlist and the more quiet outliers on the loudness scale are simialir between both the new and the old, with the exeption of an more extreme outlier on the old playlist down by the bottom of the y axis. The newer songs also seems to be higher in danceablity being more clustered towards the end of the x-axis while the older songs are more centered on the x-axis. Alot of the more energetic/high in valence songs are also amongst the newer releases but there is not a big difference between the two. 

```{r}
stones%>%
  arrange(-valence)%>%
  select(track.name, valence)%>%
  head(5)%>%
  kable()

```





### Chromagram {data-commentary-width=400}

```{r}

wo <- 
    get_tidy_audio_analysis('0pNeVovbiZHkulpGeOx1Gj') %>% 
    select(segments) %>% unnest(segments) %>% 
    select(start, duration, pitches)

wo %>% 
    mutate(pitches = map(pitches, compmus_normalise, 'euclidean')) %>% 
    compmus_gather_chroma %>% 
    ggplot(
        aes(
            x = start + duration / 2, 
            width = duration, 
            y = pitch_class, 
            fill = value)) + 
    geom_tile() +
    labs(x = 'Time (s)', y = NULL, fill = 'Magnitude') +
    theme_minimal()
```

***

A chromagram of the song Something by the beatles. We see here that the song is in C major and there seems to be a key change even to A major only to then return to C major again in the outro. 




### Conclusion
From what I have found the most noticeble difference is that the music is louder and more spread out when it comes to valence and energy. Also the difference in danceability between tracks are higher. 

